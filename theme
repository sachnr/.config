#!/usr/bin/env bash

cd ~/.local/share/chezmoi || exit 1

VALID_THEMES=("cyberdream" "bamboo")

show_theme_selector() {
    printf '%s\n' "${VALID_THEMES[@]}" | rofi -dmenu -p "Select Theme" -i
}

validate_theme() {
    local theme=$1
    for valid in "${VALID_THEMES[@]}"; do
        [[ "$theme" == "$valid" ]] && return 0
    done
    return 1
}

build_oomox_themes() {
    oomox-cli "$HOME/.config/oomox/colors/chezmoi" \
        --output "oomox-chezmoi" \
        --target-dir "$HOME/.themes" \
        --hidpi true \
        --make-opts all >/dev/null 2>&1
    if command -v oomox-gnome-colors-icon-theme &>/dev/null; then
        oomox-gnome-colors-icon-theme "$HOME/.config/oomox/colors/chezmoi" \
            -o "oomox-chezmoi" \
            -t "$HOME/.icons" >/dev/null 2>&1
    fi
}

apply_themes() {
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" 2>/dev/null
    gsettings set org.gnome.desktop.interface gtk-theme "oomox-chezmoi" 2>/dev/null
    gsettings set org.gnome.desktop.wm.preferences theme "oomox-chezmoi" 2>/dev/null
    gsettings set org.gnome.desktop.interface icon-theme "oomox-chezmoi" 2>/dev/null
    if [[ -d "$HOME/.icons/oomox-chezmoi/cursors" ]]; then
        gsettings set org.gnome.desktop.interface cursor-theme "oomox-chezmoi" 2>/dev/null
    fi
}

change_wallpapers() {
    local theme=$1
    local wallpaper_dir="$HOME/wallpapers/$theme"
    if [[ -d "$wallpaper_dir" ]]; then
        local wallpaper=$(find "$wallpaper_dir" -type f \( -name '*.jpg' -o -name '*.png' -o -name '*.jpeg' \) | shuf -n 1)
        if [[ -n "$wallpaper" ]]; then
            swww img "$wallpaper" --transition-type wipe --transition-duration 1 2>/dev/null
            echo "Set wallpaper: $(basename "$wallpaper")"
        else
            echo "No wallpapers found in $wallpaper_dir"
        fi
    else
        echo "Wallpaper directory not found: $wallpaper_dir"
    fi
}

change_chromium_path() {
    local theme_color_file="$HOME/.config/theme.chromium"
    local desktop_file="$HOME/.local/share/applications/chromium.desktop"
    if [[ ! -f "$desktop_file" ]]; then
        cp /usr/share/applications/chromium.desktop "$desktop_file"
    fi
    if [[ -f "$theme_color_file" ]]; then
        local theme_color="$(<"$theme_color_file")"
    else
        local theme_color="28,32,39"
        echo "Warning: Theme color file not found: $theme_color_file" >&2
    fi
    sed -i "s|^Exec=.*|Exec=/usr/bin/chromium --ozone-platform=wayland --ozone-platform-hint=wayland --set-theme-color=${theme_color} %U|" "$desktop_file"
    update-desktop-database "$HOME/.local/share/applications" 2>/dev/null
}

restart_components() {
    pkill -SIGUSR2 ghostty 2>/dev/null || echo "ghostty not running or failed to reload" >&2
    local theme_color_file="$HOME/.config/theme.chromium"
    if [[ -f "$theme_color_file" ]]; then
        local theme_color="$(<"$theme_color_file")"
        chromium --no-startup-window --set-theme-color="$theme_color"
    else
        chromium --no-startup-window --set-theme-color="28,32,39"
        echo "Warning: Theme color file not found: $theme_color_file" >&2
    fi
    hyprctl reload 2>/dev/null || echo "hyprctl reload failed" >&2
    fc-cache -fv >/dev/null 2>&1
    echo "All components restarted"
}

if [[ -z "$1" ]]; then
    theme=$(show_theme_selector)
    [[ -z "$theme" ]] && exit 0
else
    theme="$1"
fi

theme=$(echo "$theme" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

if ! validate_theme "$theme"; then
    echo "Theme '$theme' does not exist" >&2
    echo "Available themes: ${VALID_THEMES[*]}" >&2
    exit 2
fi

src="themes/${theme}.yaml"
dest=".chezmoidata/settings.yaml"

if [[ ! -f "$src" ]]; then
    echo "Theme file '$src' does not exist." >&2
    exit 2
fi

[[ -e "$dest" || -L "$dest" ]] && rm "$dest"
ln -nsf "$(realpath "$src")" "$dest"
echo "Switched to $theme"

if chezmoi apply >/dev/null 2>&1; then
    echo "Applied chezmoi configuration"
    build_oomox_themes
    apply_themes
    change_wallpapers "$theme"
    change_chromium_path
    restart_components
    echo "Theme '$theme' applied successfully!"
else
    echo "chezmoi apply failed" >&2
    exit 1
fi
